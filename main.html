<!DOCTYPE html>
<html lang="fr">
<body>
    <script>
        const SUPABASE_URL = 'https://rrcbprbxgonzsqldhfil.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyY2JwcmJ4Z29uenNxbGRoZmlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MzY1NjUsImV4cCI6MjA3NDExMjU2NX0.-C7VtLJA7ZLByprNBsMKSIKnH7HubPzgpIXyKEGYwrA';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle('dark-theme', savedTheme === 'dark');

            // --- LOGIQUE DE SÉCURITÉ AVEC DÉBOGAGE ---
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { 
                window.location.href = 'auth.html'; 
                return; 
            }

            // ==========================================================
            // DÉBUT DU BLOC DE DÉBOGAGE
            // ==========================================================
            
            // Alerte 1 : Confirmer l'UID de la session
            alert(`--- DÉBOGAGE 1/2 ---\nL'UID de la session est :\n${session.user.id}`);

            // On lit directement la table
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('role')
                .eq('id', session.user.id)
                .single();

            // Alerte 2 : Montrer le résultat de la recherche de profil
            alert(`--- DÉBOGAGE 2/2 ---\nRésultat de la recherche de profil :\n\nProfil trouvé : ${JSON.stringify(profile)}\n\nErreur reçue : ${JSON.stringify(error)}`);
            
            // ==========================================================
            // FIN DU BLOC DE DÉBOGAGE
            // ==========================================================


            if (error || !profile || profile.role !== 'admin') {
                alert("Accès refusé (après vérification)."); // Alerte finale pour confirmer le rejet
                await supabaseClient.auth.signOut();
                window.location.href = 'auth.html';
                return;
            }
            
            currentUser = session.user;
            await initializeApp();
        });

        // --- Le reste du script reste identique ---
        const appContent = document.getElementById('app-content');
        // ... (toutes les autres fonctions : showPage, handleRouteChange, etc.)

    </script>
</body>
</html>
