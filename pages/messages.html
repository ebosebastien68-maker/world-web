<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <strong>Messages</strong>
    <div class="search">
      <input id="msg-search" placeholder="Rechercher par mot-clÃ© ou utilisateur">
      <button class="btn" onclick="searchMessages()">ðŸ”Ž</button>
    </div>
  </div>
</div>

<div class="card">
  <div style="display:flex;gap:8px;align-items:center">
    <input id="toUser" placeholder="Destinataire (user id ou email)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e5e7eb">
    <input id="attachFile" type="file" accept="image/*,video/*" style="display:none" onchange="handleLocalFile(event)">
    <button class="btn ghost" onclick="document.getElementById('attachFile').click()">ðŸ“Ž Joindre</button>
    <button class="btn" onclick="sendMessage()">Envoyer</button>
  </div>
  <textarea id="msg-body" placeholder="Ã‰cris un message..." style="width:100%;height:80px;margin-top:10px;padding:8px;border-radius:8px;border:1px solid #e5e7eb"></textarea>
  <div id="attached-preview"></div>
</div>

<div id="messages-list" style="margin-top:12px"></div>

<style>
  /* messages specific */
  #messages-list .msg{margin-bottom:10px}
  .msg .meta{font-size:13px;color:var(--muted)}
</style>

<script>
(async function init_messages(){
  const list = document.getElementById('messages-list');
  list.innerHTML = '<div class="muted">Chargement des messages...</div>';

  // load last messages involving current user
  async function loadMessages(){
    const user = (await supabase.auth.getUser()).data?.user;
    if(!user){ list.innerHTML = '<div class="muted">Connecte-toi pour voir les messages.</div>'; return; }
    // fetch messages where sender or receiver is current user (simple approach)
    const { data, error } = await supabase
      .from('messages')
      .select('id,sender_id,receiver_id,content,media_url,created_at')
      .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
      .order('created_at', { ascending:false })
      .limit(100);
    if(error){ list.innerHTML = '<div class="card">Erreur chargement</div>'; console.error(error); return;}
    if(!data || data.length===0) { list.innerHTML = '<div class="muted">Aucun message.</div>'; return; }
    list.innerHTML = data.map(m => {
      const media = m.media_url ? `<img src="${m.media_url}" class="media-thumb">` : '';
      return `<div class="card msg"><div class="meta"><strong>${m.sender_id}</strong> â†’ <strong>${m.receiver_id}</strong> â€¢ ${new Date(m.created_at).toLocaleString()}</div><div>${escapeHtml(m.content||'')}</div>${media}<div style="margin-top:8px"><button class="btn ghost" onclick="replyMessage('${m.sender_id}')">RÃ©pondre</button></div></div>`;
    }).join('');
  }
  await loadMessages();

  // realtime incoming messages to current user
  const me = (await supabase.auth.getUser()).data?.user;
  if(me){
    supabase.channel('public:messages')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `receiver_id=eq.${me.id}` }, payload => {
        // prepend
        const m = payload.new;
        const html = `<div class="card msg"><div class="meta"><strong>${m.sender_id}</strong> â†’ <strong>${m.receiver_id}</strong> â€¢ ${new Date(m.created_at).toLocaleString()}</div><div>${escapeHtml(m.content||'')}</div></div>`;
        list.insertAdjacentHTML('afterbegin', html);
      }).subscribe();
  }

  // helpers
  window.searchMessages = async function(){
    const q = document.getElementById('msg-search').value.trim();
    if(!q) { loadMessages(); return; }
    list.innerHTML = '<div class="muted">Recherche...</div>';
    const { data } = await supabase.from('messages').select('*').ilike('content', `%${q}%`).order('created_at',{ascending:false}).limit(100);
    if(!data || data.length===0) list.innerHTML = '<div class="muted">Aucun rÃ©sultat</div>';
    else list.innerHTML = data.map(m=>`<div class="card msg"><div class="meta">${m.sender_id} â†’ ${m.receiver_id} â€¢ ${new Date(m.created_at).toLocaleString()}</div>${escapeHtml(m.content)}</div>`).join('');
  };

  window.replyMessage = function(who){
    document.getElementById('toUser').value = who;
    document.getElementById('msg-body').focus();
  };

  // media attach flow
  let attachedFile = null;
  window.handleLocalFile = function(e){
    const f = e.target.files[0];
    if(!f) return;
    attachedFile = f;
    const url = URL.createObjectURL(f);
    document.getElementById('attached-preview').innerHTML = `<img src="${url}" class="media-thumb">`;
  };

  window.sendMessage = async function(){
    const to = document.getElementById('toUser').value.trim();
    const body = document.getElementById('msg-body').value.trim();
    if(!to || (!body && !attachedFile)) return alert('Destinataire et contenu requis (ou fichier).');
    const user = (await supabase.auth.getUser()).data?.user;
    if(!user) return alert('Connecte-toi');

    let media_url = null;
    if(attachedFile){
      // upload to Supabase Storage (bucket "public")
      try{
        // ensure bucket exists (do from dashboard ideally)
        const filePath = `messages/${Date.now()}_${attachedFile.name}`;
        const { data:up, error:upErr } = await supabase.storage.from('public').upload(filePath, attachedFile);
        if(upErr) throw upErr;
        media_url = `${SUPA_URL}/storage/v1/object/public/${up.path}`;
      }catch(err){ console.error(err); alert('Erreur upload'); }
    }

    try{
      await supabase.from('messages').insert({ sender_id: user.id, receiver_id: to, content: body, media_url });
      document.getElementById('msg-body').value='';
      document.getElementById('attached-preview').innerHTML='';
      attachedFile = null;
      alert('Message envoyÃ©');
      loadMessages();
    }catch(e){ console.error(e); alert('Erreur envoi'); }
  };

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
})();
</script>
