<style>
    .messages-layout { display: flex; height: calc(100vh - 100px); background: #fff; }
    .users-list { width: 30%; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
    .search-bar { padding: 10px; border-bottom: 1px solid #ddd; }
    .search-bar input { width: 100%; padding: 8px; border-radius: 18px; border: 1px solid #ccc; box-sizing: border-box; }
    .user-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #eee; }
    .user-item:hover, .user-item.active { background-color: #f0f2f5; }
    .chat-window { width: 70%; display: flex; flex-direction: column; }
    .chat-header { padding: 15px; border-bottom: 1px solid #ddd; font-weight: bold; }
    .messages-container { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
    .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; }
    .message-bubble.sent { background-color: #007bff; color: white; align-self: flex-end; }
    .message-bubble.received { background-color: #e9ebee; color: #333; align-self: flex-start; }
    .message-form { padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
    .message-form input { flex-grow: 1; padding: 10px; border-radius: 18px; border: 1px solid #ccc; }
    .message-form button { padding: 10px 20px; border-radius: 18px; border: none; background-color: #007bff; color: white; cursor: pointer; }
</style>

<div class="messages-layout">
    <div class="users-list">
        <div class="search-bar">
            <input type="text" id="userSearch" placeholder="Chercher un utilisateur...">
        </div>
        <div id="usersContainer" style="overflow-y: auto;">
            </div>
    </div>
    <div class="chat-window">
        <div class="chat-header" id="chatHeader">Sélectionnez un utilisateur pour discuter</div>
        <div class="messages-container" id="messagesContainer">
            </div>
        <form class="message-form" id="messageForm">
            <input type="text" id="messageInput" placeholder="Écrire un message..." required>
            <button type="submit">Envoyer</button>
        </form>
    </div>
</div>

<script>
// NOTE: Ce code nécessite une table 'messages' que vous devez créer dans Supabase.
// Schéma simple : id, created_at, sender_id (uuid), receiver_id (uuid), content (text)
(async function() {
    // ... Le code JS pour la messagerie viendrait ici.
    // En raison de sa complexité (gestion temps réel, chargement des conversations, etc.),
    // ce serait un script assez long.
    
    // Voici une version simplifiée et commentée de la logique :
    const usersContainer = document.getElementById('usersContainer');
    const chatHeader = document.getElementById('chatHeader');
    const messagesContainer = document.getElementById('messagesContainer');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const { data: { user } } = await supabase.auth.getUser();
    let currentRecipientId = null;
    let messageSubscription = null;

    // 1. Charger tous les utilisateurs
    const { data: profiles, error } = await supabase.from('profiles').select('*').neq('id', user.id);
    if (profiles) {
        usersContainer.innerHTML = profiles.map(p => `
            <div class="user-item" data-id="${p.id}" data-username="${p.username}">
                ${p.username || 'Utilisateur inconnu'}
            </div>
        `).join('');
    }

    // 2. Gérer le clic sur un utilisateur
    usersContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('user-item')) {
            currentRecipientId = e.target.dataset.id;
            chatHeader.textContent = `Discussion avec ${e.target.dataset.username}`;
            loadMessages(currentRecipientId);
        }
    });

    // 3. Charger les messages pour une conversation
    const loadMessages = async (recipientId) => {
        const { data: messages, error } = await supabase
            .from('messages')
            .select('*')
            .or(`(sender_id.eq.${user.id},receiver_id.eq.${recipientId}),(sender_id.eq.${recipientId},receiver_id.eq.${user.id})`)
            .order('created_at', { ascending: false });

        if (messages) {
            messagesContainer.innerHTML = messages.map(msg => `
                <div class="message-bubble ${msg.sender_id === user.id ? 'sent' : 'received'}">
                    ${msg.content}
                </div>
            `).join('');
        }
        
        // 4. S'abonner aux nouveaux messages en temps réel
        if (messageSubscription) {
            supabase.removeChannel(messageSubscription); // Se désabonner de l'ancienne conversation
        }
        messageSubscription = supabase.channel(`messages-${user.id}-${recipientId}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                // Recharger les messages quand un nouveau arrive
                loadMessages(recipientId);
            })
            .subscribe();
    };

    // 5. Envoyer un message
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentRecipientId || !messageInput.value) return;

        const { error } = await supabase.from('messages').insert({
            sender_id: user.id,
            receiver_id: currentRecipientId,
            content: messageInput.value
        });

        if (!error) {
            messageInput.value = '';
        }
    });

})();
              </script>
              
