<style>
    .home-container { max-width: 800px; margin: auto; }
    .post-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; padding: 20px; }
    .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
    .post-author { font-weight: bold; }
    .post-content p { margin: 0 0 15px 0; }
    .post-content img { max-width: 100%; border-radius: 8px; }
    .post-actions { display: flex; justify-content: space-around; border-top: 1px solid #e9ebee; padding-top: 10px; }
    .action-btn { background: none; border: none; cursor: pointer; font-size: 20px; transition: transform 0.2s; }
    .action-btn:hover { transform: scale(1.2); }
    .comments-section { margin-top: 20px; }
    .comment { margin-bottom: 10px; padding-left: 15px; border-left: 2px solid #eee; }
    .comment-form { display: flex; gap: 10px; margin-top: 10px; }
    .comment-form input { flex-grow: 1; padding: 8px; border-radius: 18px; border: 1px solid #ccc; }
    .comment-form button { padding: 8px 15px; border-radius: 18px; border: none; background-color: #007bff; color: white; cursor: pointer; }
</style>

<div class="home-container" id="posts-feed">
    </div>

<script>
// Ce script s'ex√©cutera une fois que ce HTML est inject√© dans main.html
(async function() {
    // La variable `supabase` est d√©j√† d√©finie dans main.html et est donc globale
    const postsFeed = document.getElementById('posts-feed');
    const { data: { user } } = await supabase.auth.getUser();

    if (!postsFeed) return;

    const fetchPosts = async () => {
        const { data: posts, error } = await supabase
            .from('posts')
            .select(`
                *,
                profiles ( username ),
                comments ( *, profiles ( username ) ),
                reactions ( * )
            `)
            .eq('is_published', true)
            .order('created_at', { ascending: false });

        if (error) {
            console.error("Erreur de chargement des posts:", error);
            postsFeed.innerHTML = '<p>Impossible de charger les articles.</p>';
            return;
        }

        renderPosts(posts);
    };

    const renderPosts = (posts) => {
        if (posts.length === 0) {
            postsFeed.innerHTML = '<p>Aucun article √† afficher pour le moment.</p>';
            return;
        }

        postsFeed.innerHTML = posts.map(post => `
            <div class="post-card" data-post-id="${post.id}">
                <div class="post-header">
                    <span class="post-author">${post.profiles.username || 'Anonyme'}</span>
                </div>
                <div class="post-content">
                    <p>${post.content}</p>
                    ${post.image_url ? `<img src="${post.image_url}" alt="Image du post">` : ''}
                    ${post.whatsapp_number ? `<a href="https://wa.me/${post.whatsapp_number}" target="_blank">Contacter sur WhatsApp</a>` : ''}
                </div>
                <div class="post-actions">
                    <button class="action-btn reaction-btn" data-reaction="üëç">üëç</button>
                    <button class="action-btn reaction-btn" data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</button>
                    <button class="action-btn reaction-btn" data-reaction="ü§£">ü§£</button>
                    <button class="action-btn reaction-btn" data-reaction="üò°">üò°</button>
                </div>
                <div class="comments-section">
                    ${post.comments.map(comment => `
                        <div class="comment">
                            <strong>${comment.profiles.username || 'Anonyme'}:</strong>
                            <p>${comment.content}</p>
                            <button class="reply-btn" data-comment-id="${comment.id}">R√©pondre</button>
                        </div>
                    `).join('')}
                    <form class="comment-form">
                        <input type="text" placeholder="Ajouter un commentaire..." required>
                        <button type="submit">Envoyer</button>
                    </form>
                </div>
            </div>
        `).join('');
    };

    // --- GESTION DES √âV√âNEMENTS ---
    postsFeed.addEventListener('click', async (e) => {
        // G√©rer les r√©actions
        if (e.target.classList.contains('reaction-btn')) {
            const reaction = e.target.dataset.reaction;
            const postId = e.target.closest('.post-card').dataset.postId;
            
            // Upsert permet de mettre √† jour ou d'ins√©rer si √ßa n'existe pas
            const { error } = await supabase.from('reactions').upsert({
                post_id: postId,
                user_id: user.id,
                reaction_type: reaction
            }, { onConflict: 'post_id, user_id' });
            
            if (error) console.error("Erreur d'ajout de r√©action:", error);
            // Id√©alement, rafra√Æchir le compteur de r√©actions ici
        }
    });

    postsFeed.addEventListener('submit', async (e) => {
        // G√©rer les commentaires
        if (e.target.classList.contains('comment-form')) {
            e.preventDefault();
            const input = e.target.querySelector('input');
            const content = input.value;
            const postId = e.target.closest('.post-card').dataset.postId;

            const { error } = await supabase.from('comments').insert({
                post_id: postId,
                user_id: user.id,
                content: content
            });

            if (error) {
                console.error("Erreur d'ajout de commentaire:", error);
            } else {
                input.value = '';
                fetchPosts(); // Recharger les posts pour voir le nouveau commentaire
            }
        }
    });
    
    await fetchPosts();

})();
</script>
