<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; }
        .navbar { background-color: #fff; padding: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-around; position: fixed; top: 0; width: 100%; z-index: 1000; }
        .navbar a { text-decoration: none; color: #333; font-weight: bold; padding: 0.5rem 1rem; border-radius: 6px; }
        .navbar a.active, .navbar a:hover { background-color: #e7f3ff; color: #007bff; }
        .content { padding: 6rem 1rem 1rem 1rem; max-width: 800px; margin: 0 auto; }
        #logout-button { background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
        #logout-button:hover { background: #c82333; }

        .post-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1.5rem; padding: 1.5rem; }
        .post-header { font-weight: bold; margin-bottom: 1rem; }
        .post-content p { margin-top: 0; }
        .post-content img { max-width: 100%; border-radius: 8px; margin-top: 1rem; }
        .post-actions { display: flex; gap: 0.5rem; margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem; }
        .reaction-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; transition: transform 0.2s; }
        .reaction-btn:hover { transform: scale(1.2); }
        .comments-section { margin-top: 1rem; }
        .comment { background: #f0f2f5; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; }
        .comment-form { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .comment-form input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 0.5rem 1rem; }
        .comment-form button { background: #007bff; color: white; border: none; border-radius: 20px; padding: 0.5rem 1rem; cursor: pointer; }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="home.html" class="nav-link active">Home</a>
        <a href="messages.html" class="nav-link">Messages</a>
        <a href="groupes.html" class="nav-link">Groupes</a>
        <a href="publier.html" class="nav-link">Publier</a>
        <a href="notifications.html" class="nav-link">Notifications</a>
        <button id="logout-button">D√©connexion</button>
    </nav>

    <main class="content">
        <h1>Fil d'actualit√©</h1>
        <div id="posts-feed">
            </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://rrcbprbxgonzsqldhfil.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyY2JwcmJ4Z29uenNxbGRoZmlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1MzY1NjUsImV4cCI6MjA3NDExMjU2NX0.-C7VtLJA7ZLByprNBsMKSIKnH7HubPzgpIXyKEGYwrA';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;

        // V√©rifier la session utilisateur
        async function checkAndLoad() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'auth.html';
                return;
            }
            currentUser = session.user;
            await displayPosts();
        }

        // Afficher les articles
        async function displayPosts() {
            const feed = document.getElementById('posts-feed');
            feed.innerHTML = 'Chargement des articles...';

            // 1. Essayer de charger depuis le cache
            const cachedPosts = sessionStorage.getItem('posts');
            let posts = [];

            if (cachedPosts) {
                posts = JSON.parse(cachedPosts);
                console.log("Articles charg√©s depuis le cache.");
            } else {
                // 2. Sinon, r√©cup√©rer depuis Supabase
                console.log("Cache vide, r√©cup√©ration depuis Supabase...");
                const { data, error } = await supabase
                    .from('posts')
                    .select(`*, user:profiles(username)`)
                    .eq('is_published', true)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    feed.innerHTML = "Erreur lors du chargement des articles.";
                    console.error(error);
                    return;
                }
                posts = data;
                sessionStorage.setItem('posts', JSON.stringify(posts)); // Mettre en cache
            }

            if (posts.length === 0) {
                feed.innerHTML = "Aucun article √† afficher pour le moment.";
                return;
            }

            feed.innerHTML = ''; // Vider le message de chargement

            // 3. Construire le HTML pour chaque article
            for (const post of posts) {
                const postElement = document.createElement('div');
                postElement.className = 'post-container';
                postElement.innerHTML = `
                    <div class="post-header">
                        <strong>${post.user?.username || 'Utilisateur anonyme'}</strong>
                    </div>
                    <div class="post-content">
                        <p>${post.content}</p>
                        ${post.image_url ? `<img src="${post.image_url}" alt="Image du post">` : ''}
                    </div>
                    <div class="post-actions" data-post-id="${post.id}">
                        <button class="reaction-btn">üëç</button>
                        <button class="reaction-btn">‚ù§Ô∏è</button>
                        <button class="reaction-btn">ü§£</button>
                        <button class="reaction-btn">üò°</button>
                    </div>
                    <div class="comments-section" id="comments-for-${post.id}">
                        </div>
                    <form class="comment-form" data-post-id="${post.id}">
                        <input type="text" placeholder="Ajouter un commentaire..." required>
                        <button type="submit">Publier</button>
                    </form>
                `;
                feed.appendChild(postElement);
                
                // Charger les commentaires pour ce post
                loadComments(post.id);
            }
             
            // Attacher les √©couteurs d'√©v√©nements
            attachEventListeners();
        }
        
        // Charger les commentaires pour un post sp√©cifique
        async function loadComments(postId) {
            const commentsContainer = document.getElementById(`comments-for-${postId}`);
            const { data: comments, error } = await supabase
                .from('comments')
                .select(`*, user:profiles(username)`)
                .eq('post_id', postId)
                .is('parent_comment_id', null) // Ne r√©cup√©rer que les commentaires parents
                .order('created_at', { ascending: true });

            if (error) {
                console.error("Erreur de chargement des commentaires:", error);
                return;
            }

            commentsContainer.innerHTML = '';
            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comment';
                commentElement.innerHTML = `
                    <strong>${comment.user?.username || 'Anonyme'}:</strong>
                    <p style="margin: 0.2rem 0;">${comment.content}</p>
                    <a href="#" class="reply-btn" data-comment-id="${comment.id}">R√©pondre</a>
                `;
                commentsContainer.appendChild(commentElement);
            });
        }
        
        // Attacher les √©couteurs d'√©v√©nements pour les actions
        function attachEventListeners() {
            // Pour les formulaires de commentaire
            document.querySelectorAll('.comment-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const postId = e.target.dataset.postId;
                    const input = e.target.querySelector('input');
                    const content = input.value.trim();

                    if (!content) return;

                    const { error } = await supabase.from('comments').insert({
                        post_id: postId,
                        user_id: currentUser.id,
                        content: content
                    });

                    if (error) {
                        console.error('Erreur d\'ajout de commentaire:', error);
                    } else {
                        input.value = '';
                        loadComments(postId); // Recharger les commentaires
                    }
                });
            });

            // Pour les r√©actions
            document.querySelectorAll('.reaction-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const postId = e.target.parentElement.dataset.postId;
                    const reaction = e.target.textContent;
                    
                    // Upsert permet de cr√©er ou de mettre √† jour la r√©action de l'utilisateur
                    const { error } = await supabase.from('reactions').upsert({
                        post_id: postId,
                        user_id: currentUser.id,
                        reaction_type: reaction
                    }, { onConflict: 'post_id, user_id' });

                    if (error) {
                        console.error("Erreur d'ajout de r√©action:", error);
                    } else {
                        console.log(`R√©action '${reaction}' ajout√©e au post ${postId}`);
                        // Ici, vous pourriez ajouter un feedback visuel
                    }
                });
            });
        }
        
        // Gestion de la d√©connexion
        document.getElementById('logout-button').addEventListener('click', async () => {
            await supabase.auth.signOut();
            sessionStorage.clear();
            window.location.href = 'auth.html';
        });

        // Lancer l'application
        document.addEventListener('DOMContentLoaded', checkAndLoad);
    </script>
</body>
</html>
