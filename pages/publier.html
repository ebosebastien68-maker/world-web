<style>
    /* Utilise les variables de thème de main.html ET les nouvelles couleurs */
    :root {
        --success-color: #28a745; /* Vert pour la publication */
        --warning-color: #ffc107; /* Jaune pour les accents */
    }

    .publisher-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 25px;
    }
    .card {
        background-color: var(--bg-content);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 1px 2px var(--shadow-color);
        transition: background-color var(--transition-speed), border-color var(--transition-speed);
    }
    .card-title {
        font-size: 1.3em;
        font-weight: 600;
        margin: 0 0 20px 0;
        color: var(--text-primary);
    }
    .form-group { margin-bottom: 15px; }
    .form-group input {
        width: 100%; padding: 12px; border: 1px solid var(--border-color);
        border-radius: 8px; background-color: var(--bg-main);
        color: var(--text-primary); font-size: 1em;
    }
    .custom-link-group { display: flex; gap: 10px; margin-bottom: 10px; }

    /* --- Styles améliorés --- */
    #editTextButton {
        width: 100%; padding: 15px; font-size: 1em; font-weight: 500;
        background-color: transparent; color: var(--accent-color);
        border: 2px dashed var(--accent-color); cursor: pointer; border-radius: 8px;
        transition: all 0.2s;
    }
    #editTextButton:hover { background-color: var(--accent-color); color: white; }
    #textPreview { color: var(--text-secondary); margin-bottom: 15px; white-space: pre-wrap; word-break: break-word; }

    #localFileInput { display: none; }
    #fileUploadLabel { display: block; padding: 20px; text-align: center; border: 2px dashed var(--border-color); border-radius: 8px; cursor: pointer; }
    #fileUploadLabel:hover { border-color: var(--accent-color); }
    #fileName { color: var(--accent-color); font-weight: 500; margin-top: 10px; }

    .accordion details { margin-bottom: 10px; }
    .accordion summary { font-weight: 600; padding: 15px; cursor: pointer; border-radius: 8px; background-color: var(--bg-main); list-style: none; position: relative; }
    .accordion summary::after { content: '›'; position: absolute; right: 15px; font-size: 1.5em; transform: rotate(90deg); transition: transform 0.2s; }
    .accordion details[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
    .accordion details[open] summary::after { transform: rotate(-90deg); }
    .accordion-content { padding: 20px; border: 1px solid var(--border-color); border-top: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }

    .publish-actions { position: sticky; bottom: 0; padding: 20px 0; background: linear-gradient(to top, var(--bg-main) 70%, transparent); }
    .btn-publish-final {
        width: 100%; padding: 15px; font-size: 1.1em; font-weight: 600;
        background-color: var(--success-color); /* Vert */
        color: white; border: none; border-radius: 8px; cursor: pointer;
        transition: background-color 0.2s;
    }
    .btn-publish-final:hover { background-color: #218838; }

    /* Modal pour l'éditeur de texte */
    .text-editor-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; display: none; justify-content: center; align-items: center; }
    .text-editor-content { background: var(--bg-content); width: 95%; height: 90%; display: flex; flex-direction: column; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .text-editor-content textarea { flex-grow: 1; border: none; padding: 20px; font-size: 1.1em; resize: none; background: transparent; color: var(--text-primary); }
    .text-editor-actions { padding: 10px; text-align: right; }
    .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; }
    .btn-primary { background-color: var(--accent-color); color: white; }

    @media (max-width: 900px) { .publisher-grid { grid-template-columns: 1fr; } }
</style>

<div class="publisher-grid">
    <div class="main-column">
        <form id="publishForm">
            <div class="card">
                <h2 class="card-title">Contenu Principal</h2>
                <div id="textPreview">Aucun texte pour le moment.</div>
                <button type="button" id="editTextButton">Écrire / Modifier le Texte</button>
            </div>
            <div class="card">
                <h2 class="card-title">Média Local</h2>
                <label for="localFileInput" id="fileUploadLabel">
                    <span>Cliquez ou glissez un fichier ici</span>
                    <div id="fileName"></div>
                </label>
                <input type="file" id="localFileInput" accept="image/*,video/*">
            </div>
        </form>
    </div>

    <div class="sidebar-column">
        <div class="card">
            <h2 class="card-title">Options de Publication</h2>
            <div class="accordion">
                <details>
                    <summary>Images Externes</summary>
                    <div class="accordion-content" id="imageUrlsContainer"></div>
                </details>
                <details>
                    <summary>Liens WhatsApp</summary>
                    <div class="accordion-content" id="whatsappContainer"></div>
                </details>
                <details>
                    <summary>Lien d'Action (Acheter)</summary>
                    <div class="accordion-content">
                        <input type="url" id="buyLinkInput" placeholder="https://lienproduit.com">
                    </div>
                </details>
                <details>
                    <summary>Liens Personnalisés</summary>
                    <div class="accordion-content" id="customLinksContainer"></div>
                </details>
            </div>
        </div>
        <div class="publish-actions">
            <button type="submit" form="publishForm" class="btn-publish-final" id="publishButton">Publier l'Article</button>
            <div id="publishStatus" style="text-align:center; margin-top:10px;"></div>
        </div>
    </div>
</div>

<div id="textEditorModal" class="text-editor-modal">
    <div class="text-editor-content">
        <textarea id="mainContentTextarea" maxlength="125000" placeholder="Écrivez votre article ici..."></textarea>
        <div class="text-editor-actions">
            <button type="button" id="saveTextButton" class="btn btn-primary">Sauvegarder et Fermer</button>
        </div>
    </div>
</div>

<script>
(async function() {
    if (!currentUser) {
        document.querySelector('.publisher-grid').innerHTML = '<h2>Vous devez être connecté pour publier.</h2>';
        return;
    }

    let postDraft = { content: "", localFile: null, imageUrls: Array(5).fill(""), whatsappNumbers: Array(3).fill(""), buyLink: "", customLinks: Array(7).fill({ title: "", url: "" }) };
    let editMode = false;
    let postIdToUpdate = null;

    // --- FONCTIONNALITÉ ACTIVÉE : Déclaration des éléments DOM ---
    const form = document.getElementById('publishForm');
    const publishButton = document.getElementById('publishButton');
    const localFileInput = document.getElementById('localFileInput');
    const fileNameDisplay = document.getElementById('fileName');
    const textEditorModal = document.getElementById('textEditorModal');
    const editTextButton = document.getElementById('editTextButton');
    const saveTextButton = document.getElementById('saveTextButton');
    const mainContentTextarea = document.getElementById('mainContentTextarea');
    const textPreview = document.getElementById('textPreview');
    const publishStatus = document.getElementById('publishStatus');
    
    // --- FONCTIONNALITÉ ACTIVÉE : Génération des champs de formulaire ---
    function createInputs(containerId, count, placeholders) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; // Vider avant de remplir
        for (let i = 0; i < count; i++) {
            if (placeholders.length === 2) {
                const group = document.createElement('div');
                group.className = 'custom-link-group form-group';
                group.innerHTML = `
                    <input type="url" data-type="customLinks" data-index="${i}" data-field="url" placeholder="${placeholders[0]} ${i + 1}">
                    <input type="text" maxlength="20" data-type="customLinks" data-index="${i}" data-field="title" placeholder="${placeholders[1]} ${i + 1}">
                `;
                container.appendChild(group);
            } else {
                const group = document.createElement('div');
                group.className = 'form-group';
                group.innerHTML = `<input type="text" data-type="${containerId}" data-index="${i}" placeholder="${placeholders[0]} ${i + 1}">`;
                container.appendChild(group);
            }
        }
    }
    createInputs('imageUrlsContainer', 5, ['URL de l\'image']);
    createInputs('whatsappContainer', 3, ['Numéro WhatsApp (ex: 22912345678)']);
    createInputs('customLinksContainer', 7, ['URL du lien', 'Titre du bouton']);

    // --- FONCTIONNALITÉ ACTIVÉE : Logique de l'éditeur de texte ---
    editTextButton.addEventListener('click', () => {
        mainContentTextarea.value = postDraft.content;
        textEditorModal.style.display = 'flex';
    });
    saveTextButton.addEventListener('click', () => {
        postDraft.content = mainContentTextarea.value;
        textPreview.textContent = postDraft.content ? (postDraft.content.substring(0, 200) + (postDraft.content.length > 200 ? '...' : '')) : "Aucun texte pour le moment.";
        textEditorModal.style.display = 'none';
    });

    // --- FONCTIONNALITÉ ACTIVÉE : Mise à jour du "cache" en temps réel ---
    document.querySelector('.publisher-grid').addEventListener('input', (e) => {
        const target = e.target;
        if (target.id === 'localFileInput') {
            postDraft.localFile = target.files[0] || null;
            fileNameDisplay.textContent = postDraft.localFile ? `Fichier : ${postDraft.localFile.name}` : '';
            return;
        }
        if (target.id === 'buyLinkInput') {
            postDraft.buyLink = target.value;
            return;
        }
        const dataType = target.dataset.type;
        const index = parseInt(target.dataset.index, 10);
        if (dataType === 'imageUrlsContainer') postDraft.imageUrls[index] = target.value;
        if (dataType === 'whatsappContainer') postDraft.whatsappNumbers[index] = target.value;
        if (dataType === 'customLinks') {
            postDraft.customLinks[index] = { ...postDraft.customLinks[index], [target.dataset.field]: target.value };
        }
    });

    // --- FONCTIONNALITÉ ACTIVÉE : Mode Édition ---
    const params = new URLSearchParams(window.location.hash.split('?')[1]);
    postIdToUpdate = params.get('edit');

    if (postIdToUpdate) {
        editMode = true;
        publishButton.textContent = "Mettre à jour l'Article";
        const { data: postToEdit, error } = await supabaseClient.from('posts').select('*').eq('id', postIdToUpdate).single();
        if (postToEdit) {
            postDraft.content = postToEdit.content || "";
            postDraft.imageUrls = (postToEdit.image_urls || []).concat(Array(5).fill("")).slice(0, 5);
            postDraft.whatsappNumbers = (postToEdit.whatsapp_numbers || []).concat(Array(3).fill("")).slice(0, 3);
            postDraft.buyLink = postToEdit.buy_link || "";
            postDraft.customLinks = (postToEdit.custom_links || []).concat(Array(7).fill({title:"",url:""})).slice(0, 7);
            updateUIFromDraft();
        }
    }

    function updateUIFromDraft() {
        textPreview.textContent = postDraft.content ? (postDraft.content.substring(0, 200) + '...') : "Aucun texte pour le moment.";
        document.querySelectorAll('[data-type="imageUrlsContainer"]').forEach((input, i) => input.value = postDraft.imageUrls[i]);
        document.querySelectorAll('[data-type="whatsappContainer"]').forEach((input, i) => input.value = postDraft.whatsappNumbers[i]);
        document.getElementById('buyLinkInput').value = postDraft.buyLink;
        document.querySelectorAll('[data-type="customLinks"]').forEach(input => {
            const index = input.dataset.index;
            input.value = postDraft.customLinks[index]?.[input.dataset.field] || "";
        });
    }

    // --- FONCTIONNALITÉ ACTIVÉE : Publication / Mise à jour ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        publishStatus.textContent = editMode ? 'Mise à jour...' : 'Publication...';
        let mediaPublicUrl = null;

        if (postDraft.localFile) {
            const file = postDraft.localFile;
            const filePath = `public/${currentUser.id}/${Date.now()}-${file.name}`;
            const { error: uploadError } = await supabaseClient.storage.from('media').upload(filePath, file);
            if (uploadError) { publishStatus.textContent = `Erreur d'upload: ${uploadError.message}`; return; }
            mediaPublicUrl = supabaseClient.storage.from('media').getPublicUrl(filePath).data.publicUrl;
        }

        const finalData = {
            user_id: currentUser.id,
            content: postDraft.content,
            media_url: mediaPublicUrl, // Uniquement pour les nouveaux uploads
            image_urls: postDraft.imageUrls.filter(url => url),
            whatsapp_numbers: postDraft.whatsappNumbers.filter(num => num),
            buy_link: postDraft.buyLink,
            custom_links: postDraft.customLinks.filter(link => link.url && link.title)
        };
        
        let error;
        if (editMode) {
            // Note: l'upload d'un nouveau fichier en mode édition ne remplace pas l'ancien `media_url` pour l'instant.
            // Il faudrait une logique plus complexe pour supprimer l'ancien fichier.
            const { error: updateError } = await supabaseClient.from('posts').update(finalData).eq('id', postIdToUpdate);
            error = updateError;
        } else {
            const { error: insertError } = await supabaseClient.from('posts').insert(finalData);
            error = insertError;
        }

        if (error) {
            publishStatus.textContent = `Erreur: ${error.message}`;
            console.error(error);
        } else {
            publishStatus.textContent = editMode ? 'Article mis à jour !' : 'Article publié !';
            setTimeout(() => window.location.hash = '#home', 1500);
        }
    });

})();
 </script>
 
