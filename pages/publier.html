<style>
    .publish-trigger {
        padding: 20px;
        background: #fff;
        border: 2px dashed #ccc;
        border-radius: 8px;
        text-align: center;
        color: #888;
        cursor: pointer;
        font-size: 1.2em;
        transition: background-color 0.3s, border-color 0.3s;
    }
    .publish-trigger:hover {
        background-color: #f8f8f8;
        border-color: #aaa;
    }
    .publish-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none; /* Initially hidden */
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .publish-modal-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
    }
    .publish-modal-content h2 { margin-top: 0; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-group textarea, .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .form-group textarea { min-height: 150px; resize: vertical; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .modal-actions button { padding: 10px 20px; border-radius: 4px; border: none; cursor: pointer; }
    .btn-publish { background-color: #007bff; color: white; }
    .btn-cancel { background-color: #ccc; }
</style>

<div class="publish-trigger" id="publishTrigger">
    Cliquez ici pour écrire un article...
</div>

<div class="publish-modal" id="publishModal">
    <div class="publish-modal-content">
        <h2>Créer un nouvel article</h2>
        <form id="publishForm">
            <div class="form-group">
                <label for="postContent">Texte de l'article</label>
                <textarea id="postContent" placeholder="Écrivez votre pensée ici..." required></textarea>
            </div>
            <div class="form-group">
                <label for="imageUrl">URL de l'image (optionnel)</label>
                <input type="url" id="imageUrl" placeholder="https://exemple.com/image.jpg">
            </div>
            <div class="form-group">
                <label for="mediaFile">Importer un média local (optionnel)</label>
                <input type="file" id="mediaFile" accept="image/*,video/*">
            </div>
             <div class="form-group">
                <label for="whatsappNumber">Numéro WhatsApp (optionnel)</label>
                <input type="text" id="whatsappNumber" placeholder="Ex: 229XXXXXXXX (avec l'indicatif pays)">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" id="cancelPublish">Annuler</button>
                <button type="submit" class="btn-publish">Publier</button>
            </div>
        </form>
        <div id="publishStatus"></div>
    </div>
</div>

<script>
(async function() {
    const publishTrigger = document.getElementById('publishTrigger');
    const publishModal = document.getElementById('publishModal');
    const cancelPublishBtn = document.getElementById('cancelPublish');
    const publishForm = document.getElementById('publishForm');
    const publishStatus = document.getElementById('publishStatus');

    const { data: { user } } = await supabase.auth.getUser();

    const openModal = () => publishModal.style.display = 'flex';
    const closeModal = () => {
        publishModal.style.display = 'none';
        publishForm.reset();
        publishStatus.textContent = '';
    };

    publishTrigger.addEventListener('click', openModal);
    cancelPublishBtn.addEventListener('click', closeModal);

    publishForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        publishStatus.textContent = 'Publication en cours...';

        const content = document.getElementById('postContent').value;
        const imageUrl = document.getElementById('imageUrl').value;
        const whatsappNumber = document.getElementById('whatsappNumber').value;
        const file = document.getElementById('mediaFile').files[0];
        
        let mediaPublicUrl = null;

        // 1. Gérer l'upload du fichier si présent
        if (file) {
            const filePath = `public/${user.id}/${Date.now()}-${file.name}`;
            const { error: uploadError } = await supabase.storage
                .from('media') // Assurez-vous d'avoir un bucket "media" dans Supabase Storage
                .upload(filePath, file);

            if (uploadError) {
                console.error("Erreur d'upload:", uploadError);
                publishStatus.textContent = `Erreur d'upload: ${uploadError.message}`;
                return;
            }

            // Obtenir l'URL publique du fichier uploadé
            const { data } = supabase.storage.from('media').getPublicUrl(filePath);
            mediaPublicUrl = data.publicUrl;
        }

        // 2. Insérer les données dans la table 'posts'
        const { error: insertError } = await supabase.from('posts').insert({
            user_id: user.id,
            content: content,
            image_url: imageUrl,
            media_url: mediaPublicUrl,
            whatsapp_number: whatsappNumber,
            is_published: true
        });

        if (insertError) {
            console.error("Erreur de publication:", insertError);
            publishStatus.textContent = `Erreur de publication: ${insertError.message}`;
        } else {
            publishStatus.textContent = 'Article publié avec succès !';
            setTimeout(() => {
                closeModal();
                // Rediriger vers la page d'accueil pour voir le nouveau post
                window.location.hash = '#home';
            }, 1500);
        }
    });
})();
                                       </script>
                                       
