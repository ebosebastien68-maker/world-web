<style>
    .publisher-container { display: flex; flex-direction: column; gap: 25px; }
    .form-section { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .form-section legend { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; color: #555; }
    .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .custom-link-group { display: flex; gap: 10px; margin-bottom: 10px; }
    .custom-link-group input:first-child { flex: 2; } /* Larger space for URL */
    .custom-link-group input:last-child { flex: 1; } /* Smaller space for Title */
    
    /* Styles pour le déclencheur de texte */
    .text-editor-trigger { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; }
    .text-preview { white-space: pre-wrap; max-height: 100px; overflow: hidden; text-overflow: ellipsis; }

    /* Styles pour le pop-up de l'éditeur de texte */
    .text-editor-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8); z-index: 1000;
        display: none; justify-content: center; align-items: center;
    }
    .text-editor-content { background: white; width: 95%; height: 90%; display: flex; flex-direction: column; border-radius: 8px; }
    .text-editor-content textarea { flex-grow: 1; border: none; padding: 20px; font-size: 1.1em; resize: none; }
    .text-editor-actions { padding: 10px; display: flex; justify-content: flex-end; }
    .btn { padding: 10px 20px; border-radius: 4px; border: none; cursor: pointer; }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-publish-final { background-color: #28a745; color: white; padding: 15px; font-size: 1.2em; width: 100%; }
</style>

<div class="publisher-container">
    <form id="publishForm">
        <fieldset class="form-section">
            <legend>Contenu Principal</legend>
            <div id="textEditorTrigger" class="text-editor-trigger">
                <div id="textPreview">Cliquez ici pour écrire votre texte...</div>
                <button type="button" id="editTextButton" class="btn" style="margin-top: 10px;">Écrire / Modifier</button>
            </div>
        </fieldset>

        <fieldset class="form-section">
            <legend>Média Local</legend>
            <input type="file" id="localFileInput" accept="image/*,video/*">
        </fieldset>

        <fieldset class="form-section">
            <legend>Images Externes (5 max)</legend>
            <div id="imageUrlsContainer"></div>
        </fieldset>
        
        <fieldset class="form-section">
            <legend>Liens WhatsApp (3 max)</legend>
            <div id="whatsappContainer"></div>
        </fieldset>
        
        <fieldset class="form-section">
            <legend>Lien d'Action (ex: Acheter)</legend>
            <input type="url" id="buyLinkInput" placeholder="https://lienversunproduit.com">
        </fieldset>

        <fieldset class="form-section">
            <legend>Liens Personnalisés (7 max)</legend>
            <div id="customLinksContainer"></div>
        </fieldset>

        <button type="submit" class="btn-publish-final">Publier l'Article</button>
        <div id="publishStatus" style="text-align:center; margin-top:15px;"></div>
    </form>
</div>

<div id="textEditorModal" class="text-editor-modal">
    <div class="text-editor-content">
        <textarea id="mainContentTextarea" maxlength="125000" placeholder="Écrivez votre article ici..."></textarea>
        <div class="text-editor-actions">
            <button type="button" id="saveTextButton" class="btn btn-primary">Sauvegarder le texte</button>
        </div>
    </div>
</div>

<script>
(async function() {
    // La variable currentUser est définie dans main.html et est accessible globalement
    if (!currentUser) {
        document.querySelector('.publisher-container').innerHTML = '<h2>Vous devez être connecté pour publier.</h2>';
        return;
    }

    // --- Objet "Cache" pour stocker les données du brouillon ---
    let postDraft = {
        content: "",
        localFile: null,
        imageUrls: Array(5).fill(""),
        whatsappNumbers: Array(3).fill(""),
        buyLink: "",
        customLinks: Array(7).fill({ title: "", url: "" })
    };

    // --- DOM Elements ---
    const form = document.getElementById('publishForm');
    const textEditorModal = document.getElementById('textEditorModal');
    const editTextButton = document.getElementById('editTextButton');
    const saveTextButton = document.getElementById('saveTextButton');
    const mainContentTextarea = document.getElementById('mainContentTextarea');
    const textPreview = document.getElementById('textPreview');
    const localFileInput = document.getElementById('localFileInput');
    const publishStatus = document.getElementById('publishStatus');

    // --- Génération dynamique des champs ---
    function createInputs(containerId, count, placeholders) {
        const container = document.getElementById(containerId);
        for (let i = 0; i < count; i++) {
            if (placeholders.length === 2) { // Cas des liens personnalisés
                const group = document.createElement('div');
                group.className = 'custom-link-group';
                group.innerHTML = `
                    <input type="url" data-type="${containerId}" data-index="${i}" data-field="url" placeholder="${placeholders[0]} ${i + 1}">
                    <input type="text" maxlength="20" data-type="${containerId}" data-index="${i}" data-field="title" placeholder="${placeholders[1]} ${i + 1}">
                `;
                container.appendChild(group);
            } else {
                container.innerHTML += `<div class="form-group"><input type="text" data-type="${containerId}" data-index="${i}" placeholder="${placeholders[0]} ${i + 1}"></div>`;
            }
        }
    }
    createInputs('imageUrlsContainer', 5, ['URL de l\'image']);
    createInputs('whatsappContainer', 3, ['Numéro WhatsApp (ex: 22912345678)']);
    createInputs('customLinksContainer', 7, ['URL du lien', 'Titre du bouton']);

    // --- Logique de l'éditeur de texte ---
    editTextButton.addEventListener('click', () => {
        mainContentTextarea.value = postDraft.content;
        textEditorModal.style.display = 'flex';
    });

    saveTextButton.addEventListener('click', () => {
        postDraft.content = mainContentTextarea.value;
        textPreview.textContent = postDraft.content.substring(0, 200) + (postDraft.content.length > 200 ? '...' : '');
        if (!postDraft.content) textPreview.textContent = "Cliquez ici pour écrire votre texte...";
        textEditorModal.style.display = 'none';
    });

    // --- Mise à jour du "Cache" en temps réel ---
    form.addEventListener('change', (e) => {
        const target = e.target;
        if (target.id === 'localFileInput') {
            postDraft.localFile = target.files[0] || null;
            return;
        }
        if (target.id === 'buyLinkInput') {
            postDraft.buyLink = target.value;
            return;
        }

        const dataType = target.dataset.type;
        const index = parseInt(target.dataset.index, 10);
        
        if (dataType === 'imageUrlsContainer') postDraft.imageUrls[index] = target.value;
        if (dataType === 'whatsappContainer') postDraft.whatsappNumbers[index] = target.value;
        if (dataType === 'customLinksContainer') {
            postDraft.customLinks[index] = { ...postDraft.customLinks[index], [target.dataset.field]: target.value };
        }
    });

    // --- Logique de Publication Finale ---
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        publishStatus.textContent = 'Publication en cours...';

        let mediaPublicUrl = null;
        // 1. Upload du média local si présent
        if (postDraft.localFile) {
            const file = postDraft.localFile;
            const filePath = `public/${currentUser.id}/${Date.now()}-${file.name}`;
            const { error } = await supabaseClient.storage.from('media').upload(filePath, file);
            if (error) {
                publishStatus.textContent = `Erreur d'upload: ${error.message}`; return;
            }
            mediaPublicUrl = supabaseClient.storage.from('media').getPublicUrl(filePath).data.publicUrl;
        }

        // 2. Nettoyage des données (retirer les entrées vides)
        const finalData = {
            user_id: currentUser.id,
            content: postDraft.content,
            media_url: mediaPublicUrl,
            image_urls: postDraft.imageUrls.filter(url => url), // Garde seulement les URLs non vides
            whatsapp_numbers: postDraft.whatsappNumbers.filter(num => num),
            buy_link: postDraft.buyLink,
            custom_links: postDraft.customLinks.filter(link => link.url && link.title)
        };

        // 3. Insertion dans Supabase
        const { error } = await supabaseClient.from('posts').insert(finalData);

        if (error) {
            publishStatus.textContent = `Erreur de publication: ${error.message}`;
            console.error(error);
        } else {
            publishStatus.textContent = 'Article publié avec succès !';
            setTimeout(() => window.location.hash = '#home', 1500);
        }
    });
})();
            </script>
            
